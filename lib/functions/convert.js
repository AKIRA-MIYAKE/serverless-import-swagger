"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createFunctionName = exports.createServiceName = exports.getOperationConfig = exports.getDocumentConfig = exports.getOperations = exports.getPaths = exports.createIsolatedSlsServie = exports.createOperationObjects = exports.collectOperationObjects = exports.default = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _changeCase = _interopRequireDefault(require("change-case"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _default = (apiDocuments, config) => {
  const operationObjects = collectOperationObjects(apiDocuments, config);
  const isolatedSLSServices = operationObjects.map(obj => createIsolatedSlsServie(obj));
  const serviceNames = new Set();
  isolatedSLSServices.forEach(s => {
    serviceNames.add(s.service);
  });
  return Array.from(serviceNames).map(sn => {
    const services = isolatedSLSServices.filter(s => s.service === sn);
    return _lodash.default.merge({}, ...services);
  });
};

exports.default = _default;

const collectOperationObjects = (apiDocuments, config) => {
  const docConfigs = apiDocuments.map(doc => getDocumentConfig(doc));
  const operationObjectsArray = apiDocuments.map((doc, i) => {
    const contextConfig = _lodash.default.merge({}, config, docConfigs[i]);

    const paths = getPaths(doc);
    const ops = paths.getPathItems().map(pathItem => {
      return createOperationObjects(pathItem, contextConfig);
    });
    return _lodash.default.flatten(ops);
  });
  return _lodash.default.flatten(operationObjectsArray);
};

exports.collectOperationObjects = collectOperationObjects;

const createOperationObjects = (pathItem, contextConfig) => {
  const path = pathItem.getPath();
  const operations = getOperations(pathItem);
  const operationObjects = [];
  operations.forEach(operation => {
    const operationConfig = getOperationConfig(operation);

    if (!contextConfig.all && typeof operationConfig === 'undefined') {
      return;
    }

    operationObjects.push({
      path,
      method: operation.getMethod().toLowerCase(),
      operationId: operation.operationId,
      config: _lodash.default.merge({}, contextConfig, operationConfig)
    });
  });

  if (operationObjects.some(oo => oo.config.options.optionsMethod) && operationObjects.every(oo => oo.method !== 'options')) {
    operationObjects.push({
      path,
      method: 'options',
      config: contextConfig
    });
  }

  return operationObjects;
};

exports.createOperationObjects = createOperationObjects;

const createIsolatedSlsServie = operationObject => {
  const service = createServiceName(operationObject);
  const functionName = createFunctionName(operationObject);
  const handler = `handler.${functionName}`;
  let path;

  if (operationObject.config.basePath === false) {
    path = operationObject.path;
  } else {
    const splited = operationObject.path.slice(1).split('/');
    path = splited.length === 1 ? '/' : `/${splited.slice(1).join('/')}`;
  }

  const httpEvent = {
    http: {
      path,
      method: operationObject.method,
      integration: 'lambda-proxy'
    }
  };
  const options = operationObject.config.options;

  if (options.cors) {
    httpEvent.http.cors = options.cors;
  }

  if (options.authorizer) {
    httpEvent.http.authorizer = options.authorizer;
  }

  const func = {
    handler,
    events: [httpEvent]
  };
  const functions = {
    [functionName]: func
  };
  return {
    service,
    functions
  };
};

exports.createIsolatedSlsServie = createIsolatedSlsServie;

const getPaths = apiDocument => {
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  return apiDocument.paths;
};

exports.getPaths = getPaths;

const getOperations = pathItem => {
  return [pathItem.get, pathItem.put, pathItem.post, pathItem.delete, pathItem.options, pathItem.head, pathItem.patch].filter(op => op !== null);
};

exports.getOperations = getOperations;

const getDocumentConfig = apiDocument => {
  const extension = apiDocument.getExtension('x-sis-config');
  return extension ? extension.value : undefined;
};

exports.getDocumentConfig = getDocumentConfig;

const getOperationConfig = operation => {
  const extension = operation.getExtension('x-sis-config');
  return extension ? extension.value : undefined;
};

exports.getOperationConfig = getOperationConfig;

const createServiceName = operationObject => {
  const {
    path,
    config
  } = operationObject;
  const {
    basePath
  } = config;

  if (basePath === false) {
    return config.serviceName;
  } else {
    let prefix;

    if (basePath === true) {
      prefix = undefined;
    } else {
      prefix = basePath.servicePrefix;
    }

    const pathArray = path.split('/').filter(p => p.length > 0);

    if (pathArray.length === 0) {
      throw new Error('Can not use the root path when the base path option is enabled.');
    }

    const subName = _changeCase.default.paramCase(pathArray[0]);

    return prefix ? `${prefix}-${subName}` : subName;
  }
};

exports.createServiceName = createServiceName;

const createFunctionName = operationObject => {
  const {
    path,
    method,
    operationId,
    config
  } = operationObject;
  const {
    basePath,
    options
  } = config;

  if (options.operationId && typeof operationId === 'string') {
    return operationId;
  }

  const resources = path.split('/').filter(w => w.length > 0).filter((w, i) => basePath ? i !== 0 : true).reduce((acc, current, index, arr) => {
    if (/^\{.*\}$/.test(current)) {
      return acc;
    } else {
      if (/^\{.*\}$/.test(arr[index - 1])) {
        return [current];
      } else {
        return [...acc, current];
      }
    }
  }, []).filter(w => !/^\{.*\}$/.test(w)).map(w => _changeCase.default.pascalCase(w));
  const conditions = path.split('/').filter(w => w.length > 0).filter(w => /^\{.*\}$/.test(w)).map((w, i) => {
    const n = _changeCase.default.dotCase(w.slice(1, -1)).split('.').map(s => _changeCase.default.pascalCase(s.slice(0, 3))).join('');

    return i === 0 ? `With${n}` : n;
  });
  return [method, ...resources, ...conditions].join('');
};

exports.createFunctionName = createFunctionName;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mdW5jdGlvbnMvY29udmVydC50cyJdLCJuYW1lcyI6WyJhcGlEb2N1bWVudHMiLCJjb25maWciLCJvcGVyYXRpb25PYmplY3RzIiwiY29sbGVjdE9wZXJhdGlvbk9iamVjdHMiLCJpc29sYXRlZFNMU1NlcnZpY2VzIiwibWFwIiwib2JqIiwiY3JlYXRlSXNvbGF0ZWRTbHNTZXJ2aWUiLCJzZXJ2aWNlTmFtZXMiLCJTZXQiLCJmb3JFYWNoIiwicyIsImFkZCIsInNlcnZpY2UiLCJBcnJheSIsImZyb20iLCJzbiIsInNlcnZpY2VzIiwiZmlsdGVyIiwiXyIsIm1lcmdlIiwiZG9jQ29uZmlncyIsImRvYyIsImdldERvY3VtZW50Q29uZmlnIiwib3BlcmF0aW9uT2JqZWN0c0FycmF5IiwiaSIsImNvbnRleHRDb25maWciLCJwYXRocyIsImdldFBhdGhzIiwib3BzIiwiZ2V0UGF0aEl0ZW1zIiwicGF0aEl0ZW0iLCJjcmVhdGVPcGVyYXRpb25PYmplY3RzIiwiZmxhdHRlbiIsInBhdGgiLCJnZXRQYXRoIiwib3BlcmF0aW9ucyIsImdldE9wZXJhdGlvbnMiLCJvcGVyYXRpb24iLCJvcGVyYXRpb25Db25maWciLCJnZXRPcGVyYXRpb25Db25maWciLCJhbGwiLCJwdXNoIiwibWV0aG9kIiwiZ2V0TWV0aG9kIiwidG9Mb3dlckNhc2UiLCJvcGVyYXRpb25JZCIsInNvbWUiLCJvbyIsIm9wdGlvbnMiLCJvcHRpb25zTWV0aG9kIiwiZXZlcnkiLCJvcGVyYXRpb25PYmplY3QiLCJjcmVhdGVTZXJ2aWNlTmFtZSIsImZ1bmN0aW9uTmFtZSIsImNyZWF0ZUZ1bmN0aW9uTmFtZSIsImhhbmRsZXIiLCJiYXNlUGF0aCIsInNwbGl0ZWQiLCJzbGljZSIsInNwbGl0IiwibGVuZ3RoIiwiam9pbiIsImh0dHBFdmVudCIsImh0dHAiLCJpbnRlZ3JhdGlvbiIsImNvcnMiLCJhdXRob3JpemVyIiwiZnVuYyIsImV2ZW50cyIsImZ1bmN0aW9ucyIsImFwaURvY3VtZW50IiwiZ2V0IiwicHV0IiwicG9zdCIsImRlbGV0ZSIsImhlYWQiLCJwYXRjaCIsIm9wIiwiZXh0ZW5zaW9uIiwiZ2V0RXh0ZW5zaW9uIiwidmFsdWUiLCJ1bmRlZmluZWQiLCJzZXJ2aWNlTmFtZSIsInByZWZpeCIsInNlcnZpY2VQcmVmaXgiLCJwYXRoQXJyYXkiLCJwIiwiRXJyb3IiLCJzdWJOYW1lIiwiY2hhbmdlQ2FzZSIsInBhcmFtQ2FzZSIsInJlc291cmNlcyIsInciLCJyZWR1Y2UiLCJhY2MiLCJjdXJyZW50IiwiaW5kZXgiLCJhcnIiLCJ0ZXN0IiwicGFzY2FsQ2FzZSIsImNvbmRpdGlvbnMiLCJuIiwiZG90Q2FzZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOzs7O2VBeUJlLENBQ2JBLFlBRGEsRUFFYkMsTUFGYSxLQUdJO0FBQ2pCLFFBQU1DLGdCQUFnQixHQUFHQyx1QkFBdUIsQ0FBQ0gsWUFBRCxFQUFlQyxNQUFmLENBQWhEO0FBQ0EsUUFBTUcsbUJBQW1CLEdBQUdGLGdCQUFnQixDQUFDRyxHQUFqQixDQUFxQkMsR0FBRyxJQUNsREMsdUJBQXVCLENBQUNELEdBQUQsQ0FERyxDQUE1QjtBQUlBLFFBQU1FLFlBQXlCLEdBQUcsSUFBSUMsR0FBSixFQUFsQztBQUNBTCxFQUFBQSxtQkFBbUIsQ0FBQ00sT0FBcEIsQ0FBNEJDLENBQUMsSUFBSTtBQUMvQkgsSUFBQUEsWUFBWSxDQUFDSSxHQUFiLENBQWlCRCxDQUFDLENBQUNFLE9BQW5CO0FBQ0QsR0FGRDtBQUlBLFNBQU9DLEtBQUssQ0FBQ0MsSUFBTixDQUFXUCxZQUFYLEVBQXlCSCxHQUF6QixDQUE2QlcsRUFBRSxJQUFJO0FBQ3hDLFVBQU1DLFFBQVEsR0FBR2IsbUJBQW1CLENBQUNjLE1BQXBCLENBQTJCUCxDQUFDLElBQUlBLENBQUMsQ0FBQ0UsT0FBRixLQUFjRyxFQUE5QyxDQUFqQjtBQUNBLFdBQU9HLGdCQUFFQyxLQUFGLENBQVEsRUFBUixFQUFZLEdBQUdILFFBQWYsQ0FBUDtBQUNELEdBSE0sQ0FBUDtBQUlELEM7Ozs7QUFFTSxNQUFNZCx1QkFBdUIsR0FBRyxDQUNyQ0gsWUFEcUMsRUFFckNDLE1BRnFDLEtBR2Y7QUFDdEIsUUFBTW9CLFVBQVUsR0FBR3JCLFlBQVksQ0FBQ0ssR0FBYixDQUFpQmlCLEdBQUcsSUFBSUMsaUJBQWlCLENBQUNELEdBQUQsQ0FBekMsQ0FBbkI7QUFDQSxRQUFNRSxxQkFBcUIsR0FBR3hCLFlBQVksQ0FBQ0ssR0FBYixDQUFpQixDQUFDaUIsR0FBRCxFQUFNRyxDQUFOLEtBQVk7QUFDekQsVUFBTUMsYUFBYSxHQUFHUCxnQkFBRUMsS0FBRixDQUFRLEVBQVIsRUFBWW5CLE1BQVosRUFBb0JvQixVQUFVLENBQUNJLENBQUQsQ0FBOUIsQ0FBdEI7O0FBQ0EsVUFBTUUsS0FBSyxHQUFHQyxRQUFRLENBQUNOLEdBQUQsQ0FBdEI7QUFDQSxVQUFNTyxHQUFHLEdBQUdGLEtBQUssQ0FBQ0csWUFBTixHQUFxQnpCLEdBQXJCLENBQXlCMEIsUUFBUSxJQUFJO0FBQy9DLGFBQU9DLHNCQUFzQixDQUFDRCxRQUFELEVBQVdMLGFBQVgsQ0FBN0I7QUFDRCxLQUZXLENBQVo7QUFHQSxXQUFPUCxnQkFBRWMsT0FBRixDQUFVSixHQUFWLENBQVA7QUFDRCxHQVA2QixDQUE5QjtBQVNBLFNBQU9WLGdCQUFFYyxPQUFGLENBQVVULHFCQUFWLENBQVA7QUFDRCxDQWZNOzs7O0FBaUJBLE1BQU1RLHNCQUFzQixHQUFHLENBQ3BDRCxRQURvQyxFQUVwQ0wsYUFGb0MsS0FHZDtBQUN0QixRQUFNUSxJQUFJLEdBQUdILFFBQVEsQ0FBQ0ksT0FBVCxFQUFiO0FBQ0EsUUFBTUMsVUFBVSxHQUFHQyxhQUFhLENBQUNOLFFBQUQsQ0FBaEM7QUFFQSxRQUFNN0IsZ0JBQW1DLEdBQUcsRUFBNUM7QUFDQWtDLEVBQUFBLFVBQVUsQ0FBQzFCLE9BQVgsQ0FBbUI0QixTQUFTLElBQUk7QUFDOUIsVUFBTUMsZUFBZSxHQUFHQyxrQkFBa0IsQ0FBQ0YsU0FBRCxDQUExQzs7QUFDQSxRQUFJLENBQUNaLGFBQWEsQ0FBQ2UsR0FBZixJQUFzQixPQUFPRixlQUFQLEtBQTJCLFdBQXJELEVBQWtFO0FBQ2hFO0FBQ0Q7O0FBRURyQyxJQUFBQSxnQkFBZ0IsQ0FBQ3dDLElBQWpCLENBQXNCO0FBQ3BCUixNQUFBQSxJQURvQjtBQUVwQlMsTUFBQUEsTUFBTSxFQUFFTCxTQUFTLENBQUNNLFNBQVYsR0FBc0JDLFdBQXRCLEVBRlk7QUFHcEJDLE1BQUFBLFdBQVcsRUFBRVIsU0FBUyxDQUFDUSxXQUhIO0FBSXBCN0MsTUFBQUEsTUFBTSxFQUFFa0IsZ0JBQUVDLEtBQUYsQ0FBUSxFQUFSLEVBQVlNLGFBQVosRUFBMkJhLGVBQTNCO0FBSlksS0FBdEI7QUFNRCxHQVpEOztBQWNBLE1BQ0VyQyxnQkFBZ0IsQ0FBQzZDLElBQWpCLENBQXNCQyxFQUFFLElBQUlBLEVBQUUsQ0FBQy9DLE1BQUgsQ0FBVWdELE9BQVYsQ0FBa0JDLGFBQTlDLEtBQ0FoRCxnQkFBZ0IsQ0FBQ2lELEtBQWpCLENBQXVCSCxFQUFFLElBQUlBLEVBQUUsQ0FBQ0wsTUFBSCxLQUFjLFNBQTNDLENBRkYsRUFHRTtBQUNBekMsSUFBQUEsZ0JBQWdCLENBQUN3QyxJQUFqQixDQUFzQjtBQUNwQlIsTUFBQUEsSUFEb0I7QUFFcEJTLE1BQUFBLE1BQU0sRUFBRSxTQUZZO0FBR3BCMUMsTUFBQUEsTUFBTSxFQUFFeUI7QUFIWSxLQUF0QjtBQUtEOztBQUVELFNBQU94QixnQkFBUDtBQUNELENBbENNOzs7O0FBb0NBLE1BQU1LLHVCQUF1QixHQUNsQzZDLGVBRHFDLElBRXRCO0FBQ2YsUUFBTXZDLE9BQU8sR0FBR3dDLGlCQUFpQixDQUFDRCxlQUFELENBQWpDO0FBQ0EsUUFBTUUsWUFBWSxHQUFHQyxrQkFBa0IsQ0FBQ0gsZUFBRCxDQUF2QztBQUNBLFFBQU1JLE9BQU8sR0FBSSxXQUFVRixZQUFhLEVBQXhDO0FBRUEsTUFBSXBCLElBQUo7O0FBQ0EsTUFBSWtCLGVBQWUsQ0FBQ25ELE1BQWhCLENBQXVCd0QsUUFBdkIsS0FBb0MsS0FBeEMsRUFBK0M7QUFDN0N2QixJQUFBQSxJQUFJLEdBQUdrQixlQUFlLENBQUNsQixJQUF2QjtBQUNELEdBRkQsTUFFTztBQUNMLFVBQU13QixPQUFPLEdBQUdOLGVBQWUsQ0FBQ2xCLElBQWhCLENBQXFCeUIsS0FBckIsQ0FBMkIsQ0FBM0IsRUFBOEJDLEtBQTlCLENBQW9DLEdBQXBDLENBQWhCO0FBQ0ExQixJQUFBQSxJQUFJLEdBQUd3QixPQUFPLENBQUNHLE1BQVIsS0FBbUIsQ0FBbkIsR0FBdUIsR0FBdkIsR0FBOEIsSUFBR0gsT0FBTyxDQUFDQyxLQUFSLENBQWMsQ0FBZCxFQUFpQkcsSUFBakIsQ0FBc0IsR0FBdEIsQ0FBMkIsRUFBbkU7QUFDRDs7QUFFRCxRQUFNQyxTQUF1QixHQUFHO0FBQzlCQyxJQUFBQSxJQUFJLEVBQUU7QUFDSjlCLE1BQUFBLElBREk7QUFFSlMsTUFBQUEsTUFBTSxFQUFFUyxlQUFlLENBQUNULE1BRnBCO0FBR0pzQixNQUFBQSxXQUFXLEVBQUU7QUFIVDtBQUR3QixHQUFoQztBQVFBLFFBQU1oQixPQUFPLEdBQUdHLGVBQWUsQ0FBQ25ELE1BQWhCLENBQXVCZ0QsT0FBdkM7O0FBRUEsTUFBSUEsT0FBTyxDQUFDaUIsSUFBWixFQUFrQjtBQUNoQkgsSUFBQUEsU0FBUyxDQUFDQyxJQUFWLENBQWVFLElBQWYsR0FBc0JqQixPQUFPLENBQUNpQixJQUE5QjtBQUNEOztBQUVELE1BQUlqQixPQUFPLENBQUNrQixVQUFaLEVBQXdCO0FBQ3RCSixJQUFBQSxTQUFTLENBQUNDLElBQVYsQ0FBZUcsVUFBZixHQUE0QmxCLE9BQU8sQ0FBQ2tCLFVBQXBDO0FBQ0Q7O0FBRUQsUUFBTUMsSUFBaUIsR0FBRztBQUN4QlosSUFBQUEsT0FEd0I7QUFFeEJhLElBQUFBLE1BQU0sRUFBRSxDQUFDTixTQUFEO0FBRmdCLEdBQTFCO0FBS0EsUUFBTU8sU0FBUyxHQUFHO0FBQUUsS0FBQ2hCLFlBQUQsR0FBZ0JjO0FBQWxCLEdBQWxCO0FBRUEsU0FBTztBQUFFdkQsSUFBQUEsT0FBRjtBQUFXeUQsSUFBQUE7QUFBWCxHQUFQO0FBQ0QsQ0F6Q007Ozs7QUEyQ0EsTUFBTTFDLFFBQVEsR0FBSTJDLFdBQUQsSUFBb0Q7QUFDMUU7QUFDQSxTQUFRQSxXQUFELENBQXFCNUMsS0FBNUI7QUFDRCxDQUhNOzs7O0FBS0EsTUFBTVUsYUFBYSxHQUFJTixRQUFELElBQTJDO0FBQ3RFLFNBQU8sQ0FDTEEsUUFBUSxDQUFDeUMsR0FESixFQUVMekMsUUFBUSxDQUFDMEMsR0FGSixFQUdMMUMsUUFBUSxDQUFDMkMsSUFISixFQUlMM0MsUUFBUSxDQUFDNEMsTUFKSixFQUtMNUMsUUFBUSxDQUFDa0IsT0FMSixFQU1MbEIsUUFBUSxDQUFDNkMsSUFOSixFQU9MN0MsUUFBUSxDQUFDOEMsS0FQSixFQVFMM0QsTUFSSyxDQVFFNEQsRUFBRSxJQUFJQSxFQUFFLEtBQUssSUFSZixDQUFQO0FBU0QsQ0FWTTs7OztBQVlBLE1BQU12RCxpQkFBaUIsR0FDNUJnRCxXQUQrQixJQUVBO0FBQy9CLFFBQU1RLFNBQVMsR0FBR1IsV0FBVyxDQUFDUyxZQUFaLENBQXlCLGNBQXpCLENBQWxCO0FBQ0EsU0FBT0QsU0FBUyxHQUFHQSxTQUFTLENBQUNFLEtBQWIsR0FBcUJDLFNBQXJDO0FBQ0QsQ0FMTTs7OztBQU9BLE1BQU0xQyxrQkFBa0IsR0FDN0JGLFNBRGdDLElBRUE7QUFDaEMsUUFBTXlDLFNBQVMsR0FBR3pDLFNBQVMsQ0FBQzBDLFlBQVYsQ0FBdUIsY0FBdkIsQ0FBbEI7QUFDQSxTQUFPRCxTQUFTLEdBQUdBLFNBQVMsQ0FBQ0UsS0FBYixHQUFxQkMsU0FBckM7QUFDRCxDQUxNOzs7O0FBT0EsTUFBTTdCLGlCQUFpQixHQUFJRCxlQUFELElBQThDO0FBQzdFLFFBQU07QUFBRWxCLElBQUFBLElBQUY7QUFBUWpDLElBQUFBO0FBQVIsTUFBbUJtRCxlQUF6QjtBQUNBLFFBQU07QUFBRUssSUFBQUE7QUFBRixNQUFleEQsTUFBckI7O0FBRUEsTUFBSXdELFFBQVEsS0FBSyxLQUFqQixFQUF3QjtBQUN0QixXQUFPeEQsTUFBTSxDQUFDa0YsV0FBZDtBQUNELEdBRkQsTUFFTztBQUNMLFFBQUlDLE1BQUo7O0FBQ0EsUUFBSTNCLFFBQVEsS0FBSyxJQUFqQixFQUF1QjtBQUNyQjJCLE1BQUFBLE1BQU0sR0FBR0YsU0FBVDtBQUNELEtBRkQsTUFFTztBQUNMRSxNQUFBQSxNQUFNLEdBQUczQixRQUFRLENBQUM0QixhQUFsQjtBQUNEOztBQUVELFVBQU1DLFNBQVMsR0FBR3BELElBQUksQ0FBQzBCLEtBQUwsQ0FBVyxHQUFYLEVBQWdCMUMsTUFBaEIsQ0FBdUJxRSxDQUFDLElBQUlBLENBQUMsQ0FBQzFCLE1BQUYsR0FBVyxDQUF2QyxDQUFsQjs7QUFDQSxRQUFJeUIsU0FBUyxDQUFDekIsTUFBVixLQUFxQixDQUF6QixFQUE0QjtBQUMxQixZQUFNLElBQUkyQixLQUFKLENBQ0osaUVBREksQ0FBTjtBQUdEOztBQUVELFVBQU1DLE9BQU8sR0FBR0Msb0JBQVdDLFNBQVgsQ0FBcUJMLFNBQVMsQ0FBQyxDQUFELENBQTlCLENBQWhCOztBQUNBLFdBQU9GLE1BQU0sR0FBSSxHQUFFQSxNQUFPLElBQUdLLE9BQVEsRUFBeEIsR0FBNEJBLE9BQXpDO0FBQ0Q7QUFDRixDQXhCTTs7OztBQTBCQSxNQUFNbEMsa0JBQWtCLEdBQzdCSCxlQURnQyxJQUVyQjtBQUNYLFFBQU07QUFBRWxCLElBQUFBLElBQUY7QUFBUVMsSUFBQUEsTUFBUjtBQUFnQkcsSUFBQUEsV0FBaEI7QUFBNkI3QyxJQUFBQTtBQUE3QixNQUF3Q21ELGVBQTlDO0FBQ0EsUUFBTTtBQUFFSyxJQUFBQSxRQUFGO0FBQVlSLElBQUFBO0FBQVosTUFBd0JoRCxNQUE5Qjs7QUFFQSxNQUFJZ0QsT0FBTyxDQUFDSCxXQUFSLElBQXVCLE9BQU9BLFdBQVAsS0FBdUIsUUFBbEQsRUFBNEQ7QUFDMUQsV0FBT0EsV0FBUDtBQUNEOztBQUVELFFBQU04QyxTQUFTLEdBQUcxRCxJQUFJLENBQ25CMEIsS0FEZSxDQUNULEdBRFMsRUFFZjFDLE1BRmUsQ0FFUjJFLENBQUMsSUFBSUEsQ0FBQyxDQUFDaEMsTUFBRixHQUFXLENBRlIsRUFHZjNDLE1BSGUsQ0FHUixDQUFDMkUsQ0FBRCxFQUFJcEUsQ0FBSixLQUFXZ0MsUUFBUSxHQUFHaEMsQ0FBQyxLQUFLLENBQVQsR0FBYSxJQUh4QixFQUlmcUUsTUFKZSxDQUtkLENBQUNDLEdBQUQsRUFBTUMsT0FBTixFQUFlQyxLQUFmLEVBQXNCQyxHQUF0QixLQUE4QjtBQUM1QixRQUFJLFdBQVdDLElBQVgsQ0FBZ0JILE9BQWhCLENBQUosRUFBOEI7QUFDNUIsYUFBT0QsR0FBUDtBQUNELEtBRkQsTUFFTztBQUNMLFVBQUksV0FBV0ksSUFBWCxDQUFnQkQsR0FBRyxDQUFDRCxLQUFLLEdBQUcsQ0FBVCxDQUFuQixDQUFKLEVBQXFDO0FBQ25DLGVBQU8sQ0FBQ0QsT0FBRCxDQUFQO0FBQ0QsT0FGRCxNQUVPO0FBQ0wsZUFBTyxDQUFDLEdBQUdELEdBQUosRUFBU0MsT0FBVCxDQUFQO0FBQ0Q7QUFDRjtBQUNGLEdBZmEsRUFnQmQsRUFoQmMsRUFrQmY5RSxNQWxCZSxDQWtCUjJFLENBQUMsSUFBSSxDQUFDLFdBQVdNLElBQVgsQ0FBZ0JOLENBQWhCLENBbEJFLEVBbUJmeEYsR0FuQmUsQ0FtQlh3RixDQUFDLElBQUlILG9CQUFXVSxVQUFYLENBQXNCUCxDQUF0QixDQW5CTSxDQUFsQjtBQXFCQSxRQUFNUSxVQUFVLEdBQUduRSxJQUFJLENBQ3BCMEIsS0FEZ0IsQ0FDVixHQURVLEVBRWhCMUMsTUFGZ0IsQ0FFVDJFLENBQUMsSUFBSUEsQ0FBQyxDQUFDaEMsTUFBRixHQUFXLENBRlAsRUFHaEIzQyxNQUhnQixDQUdUMkUsQ0FBQyxJQUFJLFdBQVdNLElBQVgsQ0FBZ0JOLENBQWhCLENBSEksRUFJaEJ4RixHQUpnQixDQUlaLENBQUN3RixDQUFELEVBQUlwRSxDQUFKLEtBQVU7QUFDYixVQUFNNkUsQ0FBQyxHQUFHWixvQkFDUGEsT0FETyxDQUNDVixDQUFDLENBQUNsQyxLQUFGLENBQVEsQ0FBUixFQUFXLENBQUMsQ0FBWixDQURELEVBRVBDLEtBRk8sQ0FFRCxHQUZDLEVBR1B2RCxHQUhPLENBR0hNLENBQUMsSUFBSStFLG9CQUFXVSxVQUFYLENBQXNCekYsQ0FBQyxDQUFDZ0QsS0FBRixDQUFRLENBQVIsRUFBVyxDQUFYLENBQXRCLENBSEYsRUFJUEcsSUFKTyxDQUlGLEVBSkUsQ0FBVjs7QUFLQSxXQUFPckMsQ0FBQyxLQUFLLENBQU4sR0FBVyxPQUFNNkUsQ0FBRSxFQUFuQixHQUF1QkEsQ0FBOUI7QUFDRCxHQVhnQixDQUFuQjtBQWFBLFNBQU8sQ0FBQzNELE1BQUQsRUFBUyxHQUFHaUQsU0FBWixFQUF1QixHQUFHUyxVQUExQixFQUFzQ3ZDLElBQXRDLENBQTJDLEVBQTNDLENBQVA7QUFDRCxDQTdDTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgY2hhbmdlQ2FzZSBmcm9tICdjaGFuZ2UtY2FzZSc7XG5pbXBvcnQge1xuICBEb2N1bWVudCxcbiAgT2FzMzBQYXRocyxcbiAgT2FzMjBQYXRocyxcbiAgT2FzUGF0aEl0ZW0sXG4gIE9hc09wZXJhdGlvbixcbn0gZnJvbSAnYXBpY3VyaW8tZGF0YS1tb2RlbHMnO1xuXG5pbXBvcnQge1xuICBJbnRlcm5hbENvbmZpZyxcbiAgRG9jdW1lbnRDb25maWcsXG4gIE9wZXJhdGlvbkNvbmZpZyxcbiAgU2xzU2VydmljZSxcbiAgU2xzRnVuY3Rpb24sXG4gIFNsc0h0dHBFdmVudCxcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3BlcmF0aW9uT2JqZWN0IHtcbiAgcGF0aDogc3RyaW5nO1xuICBtZXRob2Q6IHN0cmluZztcbiAgb3BlcmF0aW9uSWQ/OiBzdHJpbmc7XG4gIGNvbmZpZzogSW50ZXJuYWxDb25maWc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IChcbiAgYXBpRG9jdW1lbnRzOiBEb2N1bWVudFtdLFxuICBjb25maWc6IEludGVybmFsQ29uZmlnXG4pOiBTbHNTZXJ2aWNlW10gPT4ge1xuICBjb25zdCBvcGVyYXRpb25PYmplY3RzID0gY29sbGVjdE9wZXJhdGlvbk9iamVjdHMoYXBpRG9jdW1lbnRzLCBjb25maWcpO1xuICBjb25zdCBpc29sYXRlZFNMU1NlcnZpY2VzID0gb3BlcmF0aW9uT2JqZWN0cy5tYXAob2JqID0+XG4gICAgY3JlYXRlSXNvbGF0ZWRTbHNTZXJ2aWUob2JqKVxuICApO1xuXG4gIGNvbnN0IHNlcnZpY2VOYW1lczogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG4gIGlzb2xhdGVkU0xTU2VydmljZXMuZm9yRWFjaChzID0+IHtcbiAgICBzZXJ2aWNlTmFtZXMuYWRkKHMuc2VydmljZSk7XG4gIH0pO1xuXG4gIHJldHVybiBBcnJheS5mcm9tKHNlcnZpY2VOYW1lcykubWFwKHNuID0+IHtcbiAgICBjb25zdCBzZXJ2aWNlcyA9IGlzb2xhdGVkU0xTU2VydmljZXMuZmlsdGVyKHMgPT4gcy5zZXJ2aWNlID09PSBzbik7XG4gICAgcmV0dXJuIF8ubWVyZ2Uoe30sIC4uLnNlcnZpY2VzKTtcbiAgfSk7XG59O1xuXG5leHBvcnQgY29uc3QgY29sbGVjdE9wZXJhdGlvbk9iamVjdHMgPSAoXG4gIGFwaURvY3VtZW50czogRG9jdW1lbnRbXSxcbiAgY29uZmlnOiBJbnRlcm5hbENvbmZpZ1xuKTogT3BlcmF0aW9uT2JqZWN0W10gPT4ge1xuICBjb25zdCBkb2NDb25maWdzID0gYXBpRG9jdW1lbnRzLm1hcChkb2MgPT4gZ2V0RG9jdW1lbnRDb25maWcoZG9jKSk7XG4gIGNvbnN0IG9wZXJhdGlvbk9iamVjdHNBcnJheSA9IGFwaURvY3VtZW50cy5tYXAoKGRvYywgaSkgPT4ge1xuICAgIGNvbnN0IGNvbnRleHRDb25maWcgPSBfLm1lcmdlKHt9LCBjb25maWcsIGRvY0NvbmZpZ3NbaV0pO1xuICAgIGNvbnN0IHBhdGhzID0gZ2V0UGF0aHMoZG9jKTtcbiAgICBjb25zdCBvcHMgPSBwYXRocy5nZXRQYXRoSXRlbXMoKS5tYXAocGF0aEl0ZW0gPT4ge1xuICAgICAgcmV0dXJuIGNyZWF0ZU9wZXJhdGlvbk9iamVjdHMocGF0aEl0ZW0sIGNvbnRleHRDb25maWcpO1xuICAgIH0pO1xuICAgIHJldHVybiBfLmZsYXR0ZW4ob3BzKTtcbiAgfSk7XG5cbiAgcmV0dXJuIF8uZmxhdHRlbihvcGVyYXRpb25PYmplY3RzQXJyYXkpO1xufTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZU9wZXJhdGlvbk9iamVjdHMgPSAoXG4gIHBhdGhJdGVtOiBPYXNQYXRoSXRlbSxcbiAgY29udGV4dENvbmZpZzogSW50ZXJuYWxDb25maWdcbik6IE9wZXJhdGlvbk9iamVjdFtdID0+IHtcbiAgY29uc3QgcGF0aCA9IHBhdGhJdGVtLmdldFBhdGgoKTtcbiAgY29uc3Qgb3BlcmF0aW9ucyA9IGdldE9wZXJhdGlvbnMocGF0aEl0ZW0pO1xuXG4gIGNvbnN0IG9wZXJhdGlvbk9iamVjdHM6IE9wZXJhdGlvbk9iamVjdFtdID0gW107XG4gIG9wZXJhdGlvbnMuZm9yRWFjaChvcGVyYXRpb24gPT4ge1xuICAgIGNvbnN0IG9wZXJhdGlvbkNvbmZpZyA9IGdldE9wZXJhdGlvbkNvbmZpZyhvcGVyYXRpb24pO1xuICAgIGlmICghY29udGV4dENvbmZpZy5hbGwgJiYgdHlwZW9mIG9wZXJhdGlvbkNvbmZpZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBvcGVyYXRpb25PYmplY3RzLnB1c2goe1xuICAgICAgcGF0aCxcbiAgICAgIG1ldGhvZDogb3BlcmF0aW9uLmdldE1ldGhvZCgpLnRvTG93ZXJDYXNlKCksXG4gICAgICBvcGVyYXRpb25JZDogb3BlcmF0aW9uLm9wZXJhdGlvbklkLFxuICAgICAgY29uZmlnOiBfLm1lcmdlKHt9LCBjb250ZXh0Q29uZmlnLCBvcGVyYXRpb25Db25maWcpLFxuICAgIH0pO1xuICB9KTtcblxuICBpZiAoXG4gICAgb3BlcmF0aW9uT2JqZWN0cy5zb21lKG9vID0+IG9vLmNvbmZpZy5vcHRpb25zLm9wdGlvbnNNZXRob2QpICYmXG4gICAgb3BlcmF0aW9uT2JqZWN0cy5ldmVyeShvbyA9PiBvby5tZXRob2QgIT09ICdvcHRpb25zJylcbiAgKSB7XG4gICAgb3BlcmF0aW9uT2JqZWN0cy5wdXNoKHtcbiAgICAgIHBhdGgsXG4gICAgICBtZXRob2Q6ICdvcHRpb25zJyxcbiAgICAgIGNvbmZpZzogY29udGV4dENvbmZpZyxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBvcGVyYXRpb25PYmplY3RzO1xufTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZUlzb2xhdGVkU2xzU2VydmllID0gKFxuICBvcGVyYXRpb25PYmplY3Q6IE9wZXJhdGlvbk9iamVjdFxuKTogU2xzU2VydmljZSA9PiB7XG4gIGNvbnN0IHNlcnZpY2UgPSBjcmVhdGVTZXJ2aWNlTmFtZShvcGVyYXRpb25PYmplY3QpO1xuICBjb25zdCBmdW5jdGlvbk5hbWUgPSBjcmVhdGVGdW5jdGlvbk5hbWUob3BlcmF0aW9uT2JqZWN0KTtcbiAgY29uc3QgaGFuZGxlciA9IGBoYW5kbGVyLiR7ZnVuY3Rpb25OYW1lfWA7XG5cbiAgbGV0IHBhdGg7XG4gIGlmIChvcGVyYXRpb25PYmplY3QuY29uZmlnLmJhc2VQYXRoID09PSBmYWxzZSkge1xuICAgIHBhdGggPSBvcGVyYXRpb25PYmplY3QucGF0aDtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBzcGxpdGVkID0gb3BlcmF0aW9uT2JqZWN0LnBhdGguc2xpY2UoMSkuc3BsaXQoJy8nKTtcbiAgICBwYXRoID0gc3BsaXRlZC5sZW5ndGggPT09IDEgPyAnLycgOiBgLyR7c3BsaXRlZC5zbGljZSgxKS5qb2luKCcvJyl9YDtcbiAgfVxuXG4gIGNvbnN0IGh0dHBFdmVudDogU2xzSHR0cEV2ZW50ID0ge1xuICAgIGh0dHA6IHtcbiAgICAgIHBhdGgsXG4gICAgICBtZXRob2Q6IG9wZXJhdGlvbk9iamVjdC5tZXRob2QsXG4gICAgICBpbnRlZ3JhdGlvbjogJ2xhbWJkYS1wcm94eScsXG4gICAgfSxcbiAgfTtcblxuICBjb25zdCBvcHRpb25zID0gb3BlcmF0aW9uT2JqZWN0LmNvbmZpZy5vcHRpb25zO1xuXG4gIGlmIChvcHRpb25zLmNvcnMpIHtcbiAgICBodHRwRXZlbnQuaHR0cC5jb3JzID0gb3B0aW9ucy5jb3JzO1xuICB9XG5cbiAgaWYgKG9wdGlvbnMuYXV0aG9yaXplcikge1xuICAgIGh0dHBFdmVudC5odHRwLmF1dGhvcml6ZXIgPSBvcHRpb25zLmF1dGhvcml6ZXI7XG4gIH1cblxuICBjb25zdCBmdW5jOiBTbHNGdW5jdGlvbiA9IHtcbiAgICBoYW5kbGVyLFxuICAgIGV2ZW50czogW2h0dHBFdmVudF0sXG4gIH07XG5cbiAgY29uc3QgZnVuY3Rpb25zID0geyBbZnVuY3Rpb25OYW1lXTogZnVuYyB9O1xuXG4gIHJldHVybiB7IHNlcnZpY2UsIGZ1bmN0aW9ucyB9O1xufTtcblxuZXhwb3J0IGNvbnN0IGdldFBhdGhzID0gKGFwaURvY3VtZW50OiBEb2N1bWVudCk6IE9hczMwUGF0aHMgfCBPYXMyMFBhdGhzID0+IHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgcmV0dXJuIChhcGlEb2N1bWVudCBhcyBhbnkpLnBhdGhzO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldE9wZXJhdGlvbnMgPSAocGF0aEl0ZW06IE9hc1BhdGhJdGVtKTogT2FzT3BlcmF0aW9uW10gPT4ge1xuICByZXR1cm4gW1xuICAgIHBhdGhJdGVtLmdldCxcbiAgICBwYXRoSXRlbS5wdXQsXG4gICAgcGF0aEl0ZW0ucG9zdCxcbiAgICBwYXRoSXRlbS5kZWxldGUsXG4gICAgcGF0aEl0ZW0ub3B0aW9ucyxcbiAgICBwYXRoSXRlbS5oZWFkLFxuICAgIHBhdGhJdGVtLnBhdGNoLFxuICBdLmZpbHRlcihvcCA9PiBvcCAhPT0gbnVsbCk7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0RG9jdW1lbnRDb25maWcgPSAoXG4gIGFwaURvY3VtZW50OiBEb2N1bWVudFxuKTogRG9jdW1lbnRDb25maWcgfCB1bmRlZmluZWQgPT4ge1xuICBjb25zdCBleHRlbnNpb24gPSBhcGlEb2N1bWVudC5nZXRFeHRlbnNpb24oJ3gtc2lzLWNvbmZpZycpO1xuICByZXR1cm4gZXh0ZW5zaW9uID8gZXh0ZW5zaW9uLnZhbHVlIDogdW5kZWZpbmVkO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldE9wZXJhdGlvbkNvbmZpZyA9IChcbiAgb3BlcmF0aW9uOiBPYXNPcGVyYXRpb25cbik6IE9wZXJhdGlvbkNvbmZpZyB8IHVuZGVmaW5lZCA9PiB7XG4gIGNvbnN0IGV4dGVuc2lvbiA9IG9wZXJhdGlvbi5nZXRFeHRlbnNpb24oJ3gtc2lzLWNvbmZpZycpO1xuICByZXR1cm4gZXh0ZW5zaW9uID8gZXh0ZW5zaW9uLnZhbHVlIDogdW5kZWZpbmVkO1xufTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZVNlcnZpY2VOYW1lID0gKG9wZXJhdGlvbk9iamVjdDogT3BlcmF0aW9uT2JqZWN0KTogc3RyaW5nID0+IHtcbiAgY29uc3QgeyBwYXRoLCBjb25maWcgfSA9IG9wZXJhdGlvbk9iamVjdDtcbiAgY29uc3QgeyBiYXNlUGF0aCB9ID0gY29uZmlnO1xuXG4gIGlmIChiYXNlUGF0aCA9PT0gZmFsc2UpIHtcbiAgICByZXR1cm4gY29uZmlnLnNlcnZpY2VOYW1lO1xuICB9IGVsc2Uge1xuICAgIGxldCBwcmVmaXg6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBpZiAoYmFzZVBhdGggPT09IHRydWUpIHtcbiAgICAgIHByZWZpeCA9IHVuZGVmaW5lZDtcbiAgICB9IGVsc2Uge1xuICAgICAgcHJlZml4ID0gYmFzZVBhdGguc2VydmljZVByZWZpeDtcbiAgICB9XG5cbiAgICBjb25zdCBwYXRoQXJyYXkgPSBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcC5sZW5ndGggPiAwKTtcbiAgICBpZiAocGF0aEFycmF5Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnQ2FuIG5vdCB1c2UgdGhlIHJvb3QgcGF0aCB3aGVuIHRoZSBiYXNlIHBhdGggb3B0aW9uIGlzIGVuYWJsZWQuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdWJOYW1lID0gY2hhbmdlQ2FzZS5wYXJhbUNhc2UocGF0aEFycmF5WzBdKTtcbiAgICByZXR1cm4gcHJlZml4ID8gYCR7cHJlZml4fS0ke3N1Yk5hbWV9YCA6IHN1Yk5hbWU7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVGdW5jdGlvbk5hbWUgPSAoXG4gIG9wZXJhdGlvbk9iamVjdDogT3BlcmF0aW9uT2JqZWN0XG4pOiBzdHJpbmcgPT4ge1xuICBjb25zdCB7IHBhdGgsIG1ldGhvZCwgb3BlcmF0aW9uSWQsIGNvbmZpZyB9ID0gb3BlcmF0aW9uT2JqZWN0O1xuICBjb25zdCB7IGJhc2VQYXRoLCBvcHRpb25zIH0gPSBjb25maWc7XG5cbiAgaWYgKG9wdGlvbnMub3BlcmF0aW9uSWQgJiYgdHlwZW9mIG9wZXJhdGlvbklkID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBvcGVyYXRpb25JZDtcbiAgfVxuXG4gIGNvbnN0IHJlc291cmNlcyA9IHBhdGhcbiAgICAuc3BsaXQoJy8nKVxuICAgIC5maWx0ZXIodyA9PiB3Lmxlbmd0aCA+IDApXG4gICAgLmZpbHRlcigodywgaSkgPT4gKGJhc2VQYXRoID8gaSAhPT0gMCA6IHRydWUpKVxuICAgIC5yZWR1Y2UoXG4gICAgICAoYWNjLCBjdXJyZW50LCBpbmRleCwgYXJyKSA9PiB7XG4gICAgICAgIGlmICgvXlxcey4qXFx9JC8udGVzdChjdXJyZW50KSkge1xuICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKC9eXFx7LipcXH0kLy50ZXN0KGFycltpbmRleCAtIDFdKSkge1xuICAgICAgICAgICAgcmV0dXJuIFtjdXJyZW50XTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFsuLi5hY2MsIGN1cnJlbnRdO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIFtdIGFzIHN0cmluZ1tdXG4gICAgKVxuICAgIC5maWx0ZXIodyA9PiAhL15cXHsuKlxcfSQvLnRlc3QodykpXG4gICAgLm1hcCh3ID0+IGNoYW5nZUNhc2UucGFzY2FsQ2FzZSh3KSk7XG5cbiAgY29uc3QgY29uZGl0aW9ucyA9IHBhdGhcbiAgICAuc3BsaXQoJy8nKVxuICAgIC5maWx0ZXIodyA9PiB3Lmxlbmd0aCA+IDApXG4gICAgLmZpbHRlcih3ID0+IC9eXFx7LipcXH0kLy50ZXN0KHcpKVxuICAgIC5tYXAoKHcsIGkpID0+IHtcbiAgICAgIGNvbnN0IG4gPSBjaGFuZ2VDYXNlXG4gICAgICAgIC5kb3RDYXNlKHcuc2xpY2UoMSwgLTEpKVxuICAgICAgICAuc3BsaXQoJy4nKVxuICAgICAgICAubWFwKHMgPT4gY2hhbmdlQ2FzZS5wYXNjYWxDYXNlKHMuc2xpY2UoMCwgMykpKVxuICAgICAgICAuam9pbignJyk7XG4gICAgICByZXR1cm4gaSA9PT0gMCA/IGBXaXRoJHtufWAgOiBuO1xuICAgIH0pO1xuXG4gIHJldHVybiBbbWV0aG9kLCAuLi5yZXNvdXJjZXMsIC4uLmNvbmRpdGlvbnNdLmpvaW4oJycpO1xufTtcbiJdfQ==